!DOCTYPE html
html lang=zh-TW
head
    meta charset=UTF-8
    meta name=viewport content=width=device-width, initial-scale=1.0
    title才藝班上課與收費系統title
    script src=httpscdn.tailwindcss.comscript
    style
        @import url('httpsfonts.googleapis.comcss2family=Interwght@100..900&display=swap');
        body {
            font-family 'Inter', sans-serif;
            background-color #f7f9fb;
        }
        .container {
            max-width 1200px;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 hoverbg-indigo-700 focusoutline-none focusring-2 focusring-indigo-500 focusring-opacity-50;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 hoverbg-gray-300;
        }
        .btn-primarydisabled, .btn-secondarydisabled {
            @apply bg-gray-300 text-gray-500 cursor-not-allowed hoverbg-gray-300 shadow-none;
        }
    style
    !-- Firebase SDKs --
    script type=module
        import { initializeApp } from httpswww.gstatic.comfirebasejs11.6.1firebase-app.js;
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from httpswww.gstatic.comfirebasejs11.6.1firebase-auth.js;
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, runTransaction, updateDoc, deleteDoc, arrayUnion, where, getDocs, setLogLevel } from httpswww.gstatic.comfirebasejs11.6.1firebase-firestore.js;

         設定 Firebase 變數
        const firebaseConfig = typeof __firebase_config !== 'undefined'  JSON.parse(__firebase_config)  {};
        const appId = typeof __app_id !== 'undefined'  __app_id  'default-app-id';

         初始化 Firebase
        if (Object.keys(firebaseConfig).length  0) {
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
        } else {
            console.error(Firebase Configuration is missing.);
            window.db = null;
            window.auth = null;
        }

        let currentUserId = null;
        let unsubscribeConfig = null;
        let attendanceCollectionPath = '';
        const INITIAL_TIMEOUT_MS = 5000; 

        window.data = {
            classes [],
            students [],
            enrollments {},  { studentId [classId, classId, ...] }
            records {},      { studentId_classId_YYYY-MM-DD truefalse }
        };

        const state = {
            activeView 'attendance', 
            selectedDate new Date().toISOString().substring(0, 10),
            loading true,
            message '',
            userIdDisplay 'NA',
            editingStudentId null,
            editingStudentName null,
             總結報表狀態
            summaryModalVisible false,
            summaryStartDate new Date(new Date().setDate(1)).toISOString().substring(0, 10),  本月第一天
            summaryEndDate new Date().toISOString().substring(0, 10),
            summaryData null,
            summaryLoading false
        };

         --- Core UI Renderer ---
        const render = () = {
            const disableButton = state.loading  'disabled'  '';

            document.getElementById('app').innerHTML = `
                div class=bg-white p-4 shadow-lg rounded-xl mb-4
                    div class=flex flex-wrap gap-2 text-sm font-medium
                        button onclick=changeView('config') class=${state.activeView === 'config'  'btn-primary'  'btn-secondary'}
                            課程設定
                        button
                        button onclick=changeView('students') class=${state.activeView === 'students'  'btn-primary'  'btn-secondary'}
                            學生名單
                        button
                        button onclick=changeView('attendance') class=${state.activeView === 'attendance'  'btn-primary'  'btn-secondary'}
                            點名與計算
                        button
                    div
                div
                ${renderView()}
                div class=mt-4 p-2 text-xs text-gray-500 border-t
                    使用者 ID span id=userIdDisplay${state.userIdDisplay}span
                    ${state.loading  'span class=ml-4 animate-pulse text-indigo-600載入中...span'  ''}
                div
                ${state.message  `div id=message-box class=fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl${state.message}div`  ''}
            `;
            
            if (state.message) {
                setTimeout(() = { state.message = ''; render(); }, 3000);
            }
            if (state.summaryModalVisible) {
                document.getElementById('app').insertAdjacentHTML('beforeend', renderSummaryModal());
            }
        };

        const renderView = () = {
            switch (state.activeView) {
                case 'config' return renderConfigView();
                case 'students' return renderStudentsView();
                case 'attendance' return renderAttendanceView();
                default return '';
            }
        };

         --- 1. 課程設定視圖 ---
        const renderConfigView = () = {
            const disableButton = state.loading  'disabled'  '';
            
            const classesHtml = window.data.classes.map(c = `
                li class=p-3 border-b flex justify-between items-center hoverbg-gray-50
                    div
                        span class=font-semibold text-lg${c.name}span
                        span class=text-sm text-gray-500 ml-2(${c.billingType === 'monthly'  '按月收費'  '按期收費'})span
                        div class=text-xs text-gray-400 mt-1
                            ${c.billingType === 'per-term'  `期數費用 ${c.termSessions} 堂  ${c.rate.toLocaleString()} NTD`  `月費 ${c.rate.toLocaleString()} NTD`}
                        div
                        div class=text-xs text-gray-400 mt-1上課時段 ${c.schedule && c.schedule.length  0  c.schedule.join('; ')  '未設定'}div
                    div
                li
            `).join('');

            return `
                div class=bg-white p-6 rounded-xl shadow-lg
                    h2 class=text-2xl font-bold mb-4 text-gray-800課程與費率設定h2
                    p class=text-gray-600 mb-6您可以在此處定義所有才藝班的課程、收費方式、費用和上課時段。p
                    
                    button onclick=exportTimetable() class=btn-secondary mb-4 ${disableButton}
                        匯出課表
                    button

                    ul class=border rounded-lg mb-6 divide-y
                        ${classesHtml.length  0  classesHtml  'li class=p-4 text-center text-gray-500尚無課程資料。li'}
                    ul
                    
                    h3 class=text-xl font-semibold mb-3 border-t pt-4新增課程h3
                    form onsubmit=handleClassAdd(event) class=space-y-4
                        div class=grid grid-cols-1 mdgrid-cols-4 gap-4
                            input type=text id=className placeholder=課程名稱 required class=col-span-4 mdcol-span-1 p-3 border rounded-lg ${disableButton}
                            
                            select id=billingType required onchange=updateClassRatePlaceholder(this.value) class=col-span-4 mdcol-span-1 p-3 border rounded-lg ${disableButton}
                                option value= disabled selected選擇收費方式option
                                option value=per-term按期收費 (例如 美術)option
                                option value=monthly按月收費 (例如 舞蹈)option
                            select

                            input type=number id=classRate placeholder=總費用 (例如 3500) required min=1 class=col-span-4 mdcol-span-1 p-3 border rounded-lg ${disableButton}
                            input type=number id=termSessions placeholder=期數總堂數 (按期收費適用) min=0 class=col-span-4 mdcol-span-1 p-3 border rounded-lg ${disableButton}
                            
                            input type=text id=classSchedule placeholder=上課時段 (例 週三1400, 週五1000 - 逗號分隔) class=col-span-4 p-3 border rounded-lg ${disableButton}
                            
                            button type=submit class=col-span-4 btn-primary ${disableButton}
                                新增課程
                            button
                        div
                    form
                div
                script
                    window.updateClassRatePlaceholder = (type) = {
                        const rateInput = document.getElementById('classRate');
                        const sessionInput = document.getElementById('termSessions');
                        if (type === 'per-term') {
                            rateInput.placeholder = '期數總費用 (例如 3500)';
                            sessionInput.disabled = false;
                            sessionInput.placeholder = '期數總堂數 (例如 11)';
                            sessionInput.required = true;
                        } else if (type === 'monthly') {
                            rateInput.placeholder = '每月固定費用 (例如 2000)';
                            sessionInput.disabled = true;
                            sessionInput.placeholder = '不適用';
                            sessionInput.required = false;
                        }
                    };
                script
            `;
        };

         --- 2. 學生名單視圖 ---
        const renderStudentsView = () = {
            const disableButton = state.loading  'disabled'  '';
            const studentsHtml = window.data.students.map(s = {
                const enrolledClasses = (window.data.enrollments[s.id]  [])
                    .map(classId = window.data.classes.find(c = c.id === classId).name  '未知')
                    .join(', ');

                return `
                    li class=p-3 border-b flex justify-between items-center hoverbg-gray-50
                        span class=font-semibold text-lg${s.name}span
                        div class=text-sm text-gray-500 text-right
                            div class=font-medium已報名課程div
                            div class=text-xs${enrolledClasses  '無'}div
                        div
                        button onclick=showEnrollmentModal('${s.id}', '${s.name}') class=btn-secondary ml-4 ${disableButton}
                            編輯報名
                        button
                    li
                `;
            }).join('');

            return `
                div class=bg-white p-6 rounded-xl shadow-lg
                    h2 class=text-2xl font-bold mb-4 text-gray-800學生名單與報名管理h2
                    
                    h3 class=text-xl font-semibold mb-3單一新增學生h3
                    form onsubmit=handleStudentAdd(event) class=flex mb-6 space-x-2
                        input type=text id=studentName placeholder=學生姓名 required class=flex-grow p-3 border border-gray-300 rounded-lg ${disableButton}
                        button type=submit class=btn-primary whitespace-nowrap ${disableButton}
                            新增學生
                        button
                    form

                    h3 class=text-xl font-semibold mb-3 border-t pt-4匯入名單試算表 (一鍵匯入)h3
                    form onsubmit=handleStudentImport(event) class=space-y-3 mb-6
                        textarea id=importList rows=5 placeholder=請將試算表中的學生姓名貼到此處，每行一個姓名。 class=w-full p-3 border border-gray-300 rounded-lg ${disableButton}textarea
                        button type=submit class=btn-secondary w-full ${disableButton}
                            匯入名單
                        button
                    form

                    ul class=border rounded-lg divide-y
                        ${studentsHtml.length  0  studentsHtml  'li class=p-4 text-center text-gray-500目前尚無學生。li'}
                    ul

                    ${renderEnrollmentModal()}
                div
            `;
        };

         --- 3. 點名與計算視圖 ---
        const renderAttendanceView = () = {
            const disableButton = state.loading  'disabled'  '';
            const dateInput = `input type=date id=attendanceDate value=${state.selectedDate} onchange=changeAttendanceDate(this.value) class=p-2 border border-gray-300 rounded-lg w-full mdw-auto ${disableButton}`;

            if (window.data.students.length === 0  window.data.classes.length === 0) {
                 return `
                    div class=bg-white p-8 rounded-xl shadow-lg text-center text-gray-600
                        p class=text-xl font-semibold mb-3系統尚未準備就緒p
                        p請先到「課程設定」新增課程，並到「學生名單」新增學生。p
                        p class=text-xs mt-3 text-red-500若按鈕無法點擊，請等待載入中的提示消失。p
                    div
                `;
            }

            const attendanceRows = window.data.students.map(s = {
                const enrolledClasses = window.data.enrollments[s.id]  [];
                
                if (enrolledClasses.length === 0) {
                    return `tr class=border-btd class=p-3 font-medium${s.name}tdtd colspan=${window.data.classes.length} class=p-3 text-gray-400 italic text-center未報名任何課程tdtr`;
                }
                
                const classCells = window.data.classes.map(c = {
                    const isEnrolled = enrolledClasses.includes(c.id);
                    if (!isEnrolled) {
                        return `td class=p-3 bg-gray-100 text-center-td`;
                    }

                    const key = `${s.id}_${c.id}_${state.selectedDate}`;
                    const isPresent = window.data.records[key] === true;
                    
                    return `
                        td class=p-3 text-center
                            button 
                                onclick=toggleAttendance('${s.id}', '${c.id}', '${state.selectedDate}')
                                class=w-8 h-8 rounded-full transition duration-150 ${isPresent  'bg-green-500 hoverbg-green-600 text-white shadow-md'  'bg-red-200 hoverbg-red-300 text-red-700'}
                                ${disableButton}
                            
                                ${isPresent  '✓'  'X'}
                            button
                        td
                    `;
                }).join('');


                return `
                    tr class=border-b hoverbg-blue-5050 transition duration-100
                        td class=p-3 font-semibold text-gray-700${s.name}td
                        ${classCells}
                    tr
                `;
            }).join('');
            
             表頭
            const classHeaders = window.data.classes.map(c = `th class=p-3 text-center bg-indigo-50${c.name}th`).join('');

            return `
                div class=bg-white p-6 rounded-xl shadow-lg
                    h2 class=text-2xl font-bold mb-4 text-gray-800點名記錄h2
                    
                    div class=mb-6 flex flex-col mdflex-row justify-between items-start mditems-center space-y-3 mdspace-y-0
                        p class=text-gray-600點名日期：p
                        ${dateInput}
                    div

                    div class=overflow-x-auto mb-6
                        table class=min-w-full divide-y divide-gray-200 border rounded-lg
                            thead class=bg-indigo-10070
                                tr
                                    th class=p-3 text-left w-16學生姓名th
                                    ${classHeaders}
                                tr
                            thead
                            tbody class=bg-white divide-y divide-gray-100
                                ${attendanceRows.length  0  attendanceRows  'trtd colspan='+(window.data.classes.length + 1)+' class=p-4 text-center text-gray-500尚無學生數據。tdtr'}
                            tbody
                        table
                    div
                    
                    h3 class=text-xl font-bold mb-3 text-gray-800 border-t pt-4學期月份費用總結h3
                    button onclick=showSummaryModal() class=btn-primary ${disableButton}
                        計算學期總結 (按日期範圍)
                    button
                    
                    div class=mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-sm text-yellow-800
                        p class=font-semibold mb-1提示：p
                        ul class=list-disc list-inside space-y-1
                            li點名畫面僅記錄單日出席，不顯示單日費用。li
                            li請使用上方的「計算學期總結」按鈕，設定日期範圍來計算學生的總上課次數和期費狀態。li
                        ul
                    div
                div
            `;
        };
        
         --- 總結報表 Modal ---
        const renderSummaryModal = () = {
            const loading = state.summaryLoading;
            const disableButton = loading  'disabled'  '';
            const summaryData = state.summaryData;

            let tableHtml = '';

            if (summaryData) {
                const headerCells = window.data.classes.map(c = `th class=p-3 text-center bg-indigo-100${c.name}th`).join('');

                const rows = window.data.students.map(s = {
                    const enrolledClasses = window.data.enrollments[s.id]  [];
                    const classCells = window.data.classes.map(c = {
                        if (!enrolledClasses.includes(c.id)) {
                            return `td class=p-3 bg-gray-100 text-center-td`;
                        }

                        const counts = summaryData.attendanceCounts[s.id]  {};
                        const count = counts[c.id]  0;
                        const course = window.data.classes.find(cls = cls.id === c.id);

                        let statusText = '';
                        let statusColor = '';
                        
                        if (course.billingType === 'per-term') {
                            const required = course.termSessions;
                            statusText = `${count}  ${required} 堂`;
                            statusColor = count = required  'text-green-600 font-bold'  'text-orange-600 font-semibold';
                            
                             顯示費用
                            statusText += `brspan class=text-xs text-gray-600${course.rate.toLocaleString()} NTD (期費)span`;

                        } else if (course.billingType === 'monthly') {
                            statusText = `${count} 堂`;
                            statusColor = 'text-blue-600 font-bold';
                              顯示月費
                            statusText += `brspan class=text-xs text-gray-600${course.rate.toLocaleString()} NTD (月費)span`;
                        }
                        
                        return `td class=p-3 text-center ${statusColor} min-w-[150px]${statusText}td`;
                    }).join('');
                    
                    return `
                        tr class=border-b hoverbg-blue-5050
                            td class=p-3 font-semibold text-gray-700${s.name}td
                            ${classCells}
                        tr
                    `;
                }).join('');

                tableHtml = `
                    div class=overflow-x-auto
                        table class=min-w-full divide-y divide-gray-200 border rounded-lg mt-4
                            thead
                                tr
                                    th class=p-3 text-left w-16 bg-indigo-100學生姓名th
                                    ${headerCells}
                                tr
                            thead
                            tbody class=bg-white divide-y divide-gray-100
                                ${rows}
                            tbody
                        table
                        p class=mt-4 text-sm text-gray-600總結範圍：${state.summaryStartDate} 至 ${state.summaryEndDate}p
                    div
                `;
            } else if (!loading) {
                tableHtml = 'p class=text-center p-4 text-gray-500請設定日期範圍後點擊「計算」按鈕。p';
            }

            return `
                div id=summary-modal class=fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50
                    div class=bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6
                        h3 class=text-xl font-bold mb-4 text-gray-800學期月份費用總結計算h3
                        
                        div class=flex flex-wrap items-center gap-3 mb-4 border-b pb-4
                            label class=text-gray-600從label
                            input type=date id=summaryStart value=${state.summaryStartDate} onchange=state.summaryStartDate=this.value; state.summaryData=null; render(); class=p-2 border rounded-lg
                            
                            label class=text-gray-600到label
                            input type=date id=summaryEnd value=${state.summaryEndDate} onchange=state.summaryEndDate=this.value; state.summaryData=null; render(); class=p-2 border rounded-lg
                            
                            button onclick=calculateSummary() class=btn-primary ml-auto ${disableButton}
                                ${loading  '計算中...'  '計算'}
                            button
                        div

                        ${loading  'p class=text-center p-6 text-indigo-600 animate-pulse正在從資料庫獲取總結數據...p'  tableHtml}
                        
                        div class=pt-4 flex justify-end space-x-3 border-t mt-4
                            button type=button onclick=hideSummaryModal() class=btn-secondary
                                關閉
                            button
                        div
                    div
                div
            `;
        };

         --- Firebase & Data Setup ---

        const initializeAuthAndListeners = () = {
            const timeoutId = setTimeout(() = {
                if (state.loading) {
                    console.warn(Firestore timeout Forcing UI out of loading state.);
                    state.loading = false;
                    state.userIdDisplay = '離線模式 (載入超時)';
                    window.data.classes = getInitialClasses();
                    render();
                }
            }, INITIAL_TIMEOUT_MS);

            if (!window.auth  !window.db) {
                clearTimeout(timeoutId);
                state.loading = false;
                state.userIdDisplay = '離線模式 (無儲存)';
                window.data.classes = getInitialClasses();
                render();
                return;
            }

            onAuthStateChanged(window.auth, async (user) = {
                if (user) {
                    currentUserId = user.uid;
                    state.userIdDisplay = user.uid;
                    attendanceCollectionPath = `artifacts${appId}users${currentUserId}attendance_tracker`;
                    
                    try { 
                        await initializeDataStructure();
                        startDataListeners(timeoutId);
                    } catch (e) {
                        clearTimeout(timeoutId);
                        console.error(Firebase data initialization failed, e);
                        state.loading = false; 
                        render();
                    }

                } else {
                    try {
                         const initialAuthToken = typeof __initial_auth_token !== 'undefined'  __initial_auth_token  null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.error(Firebase Auth Error, error);
                    }
                    state.loading = false; 
                    render();
                }
            });
        };
        
        const getInitialClasses = () = [
             美術 3500 NTD, 11 堂課 (按期收費)
            { id 'art', name '美術', billingType 'per-term', rate 3500, termSessions 11, schedule [] },
             立體造型 3500 NTD, 8 堂課 (按期收費)
            { id '3d', name '立體造型', billingType 'per-term', rate 3500, termSessions 8, schedule [] },
             美語繪本 1000 NTD, 8 堂課 (按期收費)
            { id 'english', name '美語繪本', billingType 'per-term', rate 1000, termSessions 8, schedule [] },
             舞蹈 預設為按月收費
            { id 'dance', name '舞蹈', billingType 'monthly', rate 2000, termSessions 0, schedule [] } 
        ];

        const initializeDataStructure = async () = {
            if (!window.db  !attendanceCollectionPath) return;

            const configRef = doc(window.db, attendanceCollectionPath, 'config');
            
            try {
                await runTransaction(window.db, async (transaction) = {
                    const configDoc = await transaction.get(configRef);
                    if (!configDoc.exists()) {
                        console.log(Setting initial configuration data.);
                        const initialClasses = getInitialClasses();

                        transaction.set(configRef, { 
                            classes initialClasses,
                            students [],
                            enrollments {}
                        });
                    }
                });
            } catch (e) {
                console.error(Transaction failed , e);
            }
        };


        const startDataListeners = (timeoutId) = {
            if (unsubscribeConfig) unsubscribeConfig();
            if (!window.db  !attendanceCollectionPath) return;

            const configRef = doc(window.db, attendanceCollectionPath, 'config');
            unsubscribeConfig = onSnapshot(configRef, (doc) = {
                clearTimeout(timeoutId); 
                if (doc.exists()) {
                    const data = doc.data();
                    window.data.classes = data.classes  [];
                    window.data.students = data.students  [];
                    window.data.enrollments = data.enrollments  {};
                }
                state.loading = false;
                render();
            }, (error) = {
                clearTimeout(timeoutId);
                console.error(Config Snapshot Error, error);
                state.loading = false; 
                render();
            });

             訂閱 Attendance Records (只訂閱當前選定日期的記錄)
             為了簡化 onSnapshot 查詢限制，我們仍訂閱整個 collection，然後在前端過濾
            const recordsQuery = query(collection(window.db, attendanceCollectionPath, 'records'));
            onSnapshot(recordsQuery, (snapshot) = {
                 window.data.records = {};
                 snapshot.forEach(doc = {
                     const rec = doc.data();
                     const key = `${rec.studentId}_${rec.classId}_${rec.date}`;
                     window.data.records[key] = rec.present;
                 });
                 render();
            }, (error) = {
                console.error(Records Snapshot Error, error);
            });
        };
        
         --- Global Functions (Public API) ---

        window.changeView = (view) = {
            state.activeView = view;
            if (view === 'attendance') {
                state.selectedDate = new Date().toISOString().substring(0, 10);
            }
            render();
        };

        window.changeAttendanceDate = (date) = {
            state.selectedDate = date;
            render();
        };

         1. 課程設定處理 (新增課程)
        window.handleClassAdd = async (e) = {
            e.preventDefault();
            if (state.loading) return;

            const name = document.getElementById('className').value.trim();
            const billingType = document.getElementById('billingType').value;
            const rate = parseInt(document.getElementById('classRate').value, 10);
            const scheduleInput = document.getElementById('classSchedule').value.trim();
            const termSessions = billingType === 'per-term'  parseInt(document.getElementById('termSessions').value, 10)  0;
            
            const schedule = scheduleInput  scheduleInput.split(',').map(s = s.trim()).filter(s = s.length  0)  [];

            if (!name  !billingType  isNaN(rate)  rate = 0  (billingType === 'per-term' && (isNaN(termSessions)  termSessions = 0))) {
                state.message = '請輸入有效的課程資訊、費率和堂數！';
                return render();
            }

            const newClass = {
                id name.toLowerCase().replace(sg, '_') + '_' + Date.now(),
                name name,
                billingType billingType,
                rate rate,
                termSessions termSessions,
                schedule schedule
            };

            const configRef = doc(window.db, attendanceCollectionPath, 'config');
            try {
                await updateDoc(configRef, {
                    classes arrayUnion(newClass)
                });
                state.message = `成功新增課程 ${name}`;
                e.target.reset(); 
            } catch (e) {
                console.error(Error adding class , e);
                state.message = '新增課程失敗！';
            }
            render();
        };
        
         2. 學生名單處理 (單一新增)
        window.handleStudentAdd = async (e) = {
            e.preventDefault();
            if (state.loading) return;

            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                state.message = '請輸入學生姓名！';
                return render();
            }

            const newStudent = {
                id 'std_' + Date.now(),
                name name
            };
            
            const configRef = doc(window.db, attendanceCollectionPath, 'config');
            try {
                await updateDoc(configRef, {
                    students arrayUnion(newStudent)
                });
                state.message = `成功新增學生 ${name}`;
                e.target.reset(); 
            } catch (e) {
                console.error(Error adding student , e);
                state.message = '新增學生失敗！';
            }
            render();
        };

         2. 學生名單處理 (匯入名單)
        window.handleStudentImport = async (e) = {
            e.preventDefault();
            if (state.loading) return;

            const importList = document.getElementById('importList').value.trim();
            if (!importList) {
                state.message = '請貼上要匯入的學生名單！';
                return render();
            }

            const names = importList.split('n')
                                    .map(name = name.trim())
                                    .filter(name = name.length  0);

            if (names.length === 0) {
                state.message = '名單中沒有有效的學生姓名。';
                return render();
            }
            
            const newStudents = names.map(name = ({
                id 'std_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9),
                name name
            }));

            const configRef = doc(window.db, attendanceCollectionPath, 'config');
            try {
                await updateDoc(configRef, {
                    students arrayUnion(...newStudents)
                });
                state.message = `成功匯入 ${newStudents.length} 位學生！`;
                document.getElementById('importList').value = ''; 
            } catch (e) {
                console.error(Error importing students , e);
                state.message = '匯入名單失敗！';
            }
            render();
        };


         顯示隱藏報名編輯 modal
        window.showEnrollmentModal = (studentId, studentName) = {
            state.editingStudentId = studentId;
            state.editingStudentName = studentName;
            render();
        };

        window.hideEnrollmentModal = () = {
            state.editingStudentId = null;
            state.editingStudentName = null;
            render();
        };

         處理報名更新 (略)
        window.handleEnrollmentUpdate = async (e, studentId) = {
            e.preventDefault();
            if (state.loading) return;

            const form = document.getElementById('enrollmentForm');
            const checkboxes = form.querySelectorAll('input[type=checkbox]checked');
            const newEnrollments = Array.from(checkboxes).map(cb = cb.value);

            const configRef = doc(window.db, attendanceCollectionPath, 'config');
            try {
                await runTransaction(window.db, async (transaction) = {
                    const configDoc = await transaction.get(configRef);
                    if (!configDoc.exists()) throw Config document does not exist!;

                    const currentEnrollments = configDoc.data().enrollments  {};
                    currentEnrollments[studentId] = newEnrollments;

                    transaction.update(configRef, {
                        enrollments currentEnrollments
                    });
                });
                state.message = `${state.editingStudentName} 的報名課程已更新！`;
                hideEnrollmentModal();
            } catch (e) {
                console.error(Error updating enrollment , e);
                state.message = '更新報名失敗！';
            }
            render();
        };


         3. 點名記錄處理 
        window.toggleAttendance = async (studentId, classId, date) = {
            if (state.loading) return;

            const key = `${studentId}_${classId}_${date}`;
            const currentPresent = window.data.records[key] === true;
            const newPresent = !currentPresent;
            
            const recordRef = doc(window.db, attendanceCollectionPath, 'records', key);
            
            try {
                if (newPresent) {
                    await setDoc(recordRef, {
                        studentId,
                        classId,
                        date,
                        present true,
                        timestamp new Date().toISOString()
                    });
                } else {
                    await deleteDoc(recordRef);
                }
                
                state.message = `${window.data.students.find(s=s.id===studentId).name} 的點名記錄已更新！`;

            } catch (e) {
                console.error(Error toggling attendance , e);
                state.message = '更新點名失敗！';
            }
        };
        
         總結報表函數
        window.showSummaryModal = () = {
            state.summaryModalVisible = true;
            state.summaryData = null;  清除上次結果
            state.summaryLoading = false;
            render();
        };

        window.hideSummaryModal = () = {
            state.summaryModalVisible = false;
            state.summaryData = null;
            render();
        };

        window.calculateSummary = async () = {
            if (state.summaryLoading) return;

            const startDate = state.summaryStartDate;
            const endDate = state.summaryEndDate;

            if (!startDate  !endDate  new Date(startDate)  new Date(endDate)) {
                state.message = '請選擇有效的日期範圍！';
                return render();
            }

            state.summaryLoading = true;
            state.summaryData = null;
            render();
            
             Step 1 Query records within the date range
            const recordsCol = collection(window.db, attendanceCollectionPath, 'records');
             由於 Firestore 的 where 查詢限制，我們只能查詢 date = startDate
             必須在前端過濾 date = endDate，但因為 date 格式一致，使用 where 查詢 date = startDate 較優
            
             為了簡化，我們將嘗試獲取所有記錄並在前端過濾，但更優的做法是使用複合查詢 (如果 App 可用)
             在此單一檔案環境，為避免 index 錯誤，我們仍使用 onSnapshot 帶來的 window.data.records 數據
             但如果數據量大，此方法會變慢。這裡假設數據量小。

            const attendanceCounts = {};

             Step 2 Calculate counts from in-memory records (window.data.records)
            for (const key in window.data.records) {
                if (window.data.records[key] === true) {
                     key format studentId_classId_YYYY-MM-DD
                    const [studentId, classId, date] = key.split('_');

                     Date range filter
                    if (date = startDate && date = endDate) {
                        if (!attendanceCounts[studentId]) attendanceCounts[studentId] = {};
                        if (!attendanceCounts[studentId][classId]) attendanceCounts[studentId][classId] = 0;
                        attendanceCounts[studentId][classId]++;
                    }
                }
            }

             Step 3 Update state
            state.summaryData = { attendanceCounts };
            state.summaryLoading = false;
            render();
        };

         匯出課表功能
        window.exportTimetable = () = {
            if (state.loading) { state.message = '系統正在載入中，請稍候！'; return render(); }
            const classes = window.data.classes;
            if (classes.length === 0) { state.message = '尚無課程可匯出！'; return render(); }

            let exportText = '--- 才藝班課程時間表 ---nn';

            classes.forEach(c = {
                const typeText = c.billingType === 'monthly'  '按月收費'  `按期收費 (${c.termSessions} 堂)`;
                const rateText = `NT$ ${c.rate.toLocaleString()}  ${c.billingType === 'monthly'  '月'  '期'}`;
                const scheduleText = c.schedule && c.schedule.length  0  c.schedule.join('; ')  '未設定時段';
                
                exportText += `課程名稱 ${c.name}n`;
                exportText += `  - 收費方式 ${typeText} (${rateText})n`;
                exportText += `  - 上課時段 ${scheduleText}n`;
                exportText += '---------------------------------n';
            });
            
            const modalHtml = `
                div id=export-modal class=fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50
                    div class=bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6
                        h3 class=text-xl font-bold mb-4 text-gray-800匯出課表h3
                        p class=mb-3 text-gray-600請複製以下內容：p
                        
                        textarea id=timetableText rows=10 readonly class=w-full p-3 border rounded-lg bg-gray-50 font-mono text-sm${exportText}textarea
                        
                        div class=pt-4 flex justify-end space-x-3
                            button type=button onclick=document.getElementById('export-modal').remove(); class=btn-secondary
                                關閉
                            button
                            button type=button onclick=copyTimetableText() class=btn-primary
                                複製到剪貼簿
                            button
                        div
                    div
                div
            `;
            document.getElementById('app').insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('timetableText').select();
        };
        
         複製文本輔助功能
        window.copyTimetableText = () = {
            const textarea = document.getElementById('timetableText');
            textarea.select();
            document.execCommand('copy');
            state.message = '課表內容已複製到剪貼簿！';
            document.getElementById('export-modal').remove();
            render();
        }

         初始化
        window.onload = () = {
            initializeAuthAndListeners();
            render();
        };

    script
head
body class=p-4 mdp-8
    div class=container mx-auto
        h1 class=text-3xl font-extrabold text-indigo-800 mb-6 border-b pb-2
            才藝班上課與收費管理系統
        h1
        div id=app
            !-- 應用程式內容將在此處渲染 --
        div
    div
body
html
